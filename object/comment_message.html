<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta content="yes" name="apple-mobile-web-app-capable">
		<meta content="yes" name="apple-touch-fullscreen">
		<meta content="telephone=no,email=no" name="format-detection">
		<script type="text/javascript" src="../js/zoom/flexible.js"></script>
		<script type="text/javascript" src="../js/zoom/flexible_css.js"></script>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../css/headerStyle.css" />
		<style>
			html,
			body {
				background-color: whitesmoke;
			}
			
			.mui-content {
				background-color: whitesmoke;
				margin-bottom: 1.419444rem !important;
			}
			
			hr {
				color: white;
				border-color: white;
			}
			
			.icon-return {
				position: absolute;
				top: 10px;
				left: 0.266666rem;
			}
			
			.attention-icon {
				width: 1.333333rem;
				position: absolute;
				right: 3%;
				top: 10px;
				
			}
			
			.icon-return img {
				width: 0.347222rem;
				height: 0.680555rem;
			}
			
			.mui-title {
				font-size: 0.416666rem;
				color: #272727;
			}
			
			.mui-bar-nav {
				background-color: #FBD940;
			}
			
			.footer-nav {
				position: fixed;
				bottom: 0;
				width: 10rem;
				height: 1.519444rem;
				background-color: whitesmoke;
				z-index: 999;
				border-top: 1px solid #C8C7CC;
				box-shadow: 1px 1px 1px 1px #A3A3A3;
			}
			
			.mui-input-row {
				width: 10rem;
				height: 1.319444rem !important;
				padding-top: 0.207777rem;
			}
			
			.mui-input-row>img {
				width: 0.458333rem;
				height: 0.458333rem;
			}
			
			.mui-input-row>input {
				width: 80% !important;
				margin-left: 10%;
				padding-left: 5% !important;
				border-radius: 7px;
				padding-bottom: 0.138888rem !important;
			}
			
			.text-content {
				color: #000000;
				line-height: 30px;
				padding:20px 5%;
			}
			
			.personal-head {
				position: relative;
				height: 1.083333rem;
			}
			
			.head-icon {
				position: absolute;
				top: 0.069444rem;
				left: 0.130555rem;
			}
			
			.head-icon img {
				width: 20%;
			}
			
			.head-title {
				top: 0.01111rem;
				font-size: 0.305555rem;
				left: 1.04444rem;
				position: absolute;
				color: #272727;
			}
			
			.head-time {
				top: 0.477777rem;
				position: absolute;
				left: 1.041111rem;
				font-size: 0.222222rem;
				color: #535353;
			}
			
			.personal-content {
				margin-left: 1.041111rem;
			}
			
			.personal-information {
				padding-bottom: 5px;
			}
			.img_content{
				margin: 0 auto;
				width: 80%;
			}
			.img_content img{
				width: 100%;
			}
			.msg-content{
				position: relative;
			}
			#comment{
				position: relative;
			}
		</style>
	</head>

	<body>
		<header id="header_box" class="mui-bar mui-bar-nav mui-bar-tab">
			<div id="header_content">
				<div class="icon-return mui-action-back"><img src="../imgs/comment_messgae/arrows.png" /></div>
				<h1 class="mui-title" id="header_title">小狐狸的树</h1>
				<img id="attention_btn" class="attention-icon" src="../imgs/attention.png" />
			</div>
		</header>
		<div class="footer-nav">
			<a href="javascript:;">
				<div class="mui-input-row" id="publish">
					<input id="comment_text" class="comment_text" type="text" placeholder="写下我的看法">
				</div>
			</a>
		</div>
		<div class="mui-content">
			<div class="msg-content">
			<p class="text-content" id="content_text">
				为了给春节返乡的人们提供更多周到的服务，中石化做了不少准备工作。其中，从2016年12月底开始，60多万热心网友投票选出8项关爱物资，包括安全背心、保暖护膝、保温杯、骑行雨衣以及蛋黄派、八宝粥、矿泉水、驾乘意外保险等，中石化组织了10000份“爱心礼包”，将这些爱心物资赠送给返乡人员。 根据往年数据，超过40%的返乡摩骑携带了老人、妇女和儿童等家属，中国石化针对这群特殊人群，将老人休息室、母婴室开进加油站。母婴室里除了有沙发、婴儿换片床外，还配置了暖风机、纸尿片、湿纸巾、温奶器、食物加热器等，老人休息室提供暖手宝、躺椅和按摩器以及简易医疗照顾等特色服务。 据介绍，今年中国石化为春节未能返乡团圆的外来务工留守子女寄送了200个爱心书包，书包里还装有文具、保温杯、保温饭盒、书籍等，在节前统一由顺丰公司快递出去。此外，238座“情暖驿站”还为所有春运出行车主提供“10+X”免费服务，包括应急药品、热水、热食、充电器、暖手宝、简易维修工具、便民油桶、食品加热设备、休息椅、道路指引等10项基础服务，部分驿站还根据实际情况推出“X”特色服务，如司机冲凉房或休息室、免费代换摩托车机油、旅游咨询等个性化服务。
			</p>
			<p class="img_content">
				<img src="../imgs/Guide-page2.png" data-preview-src="" data-preview-group="1"/>
			</p>
			</div>
			<div id="comment">
				<!--<div class="personal-information">
				<hr />
				<div class="personal-head">
					<div class="head-icon">
						<img src="../imgs/tree1.png" />
					</div>
					<div class="head-title">匪我思存</div>
					<div class="head-time">11-24 17:07</div>
				</div>
				<div class="personal-content">
					好感动，动物其实有时比人还重情重义，我以前养过一只猫，小猫最后被车撞死了，从此我再也没有养过猫了。
				</div>
			</div>-->
			</div>
		</div>
		<script src="../js/mui.min.js"></script>
		<script src="../js/immersion.js"></script>
		<script type="text/javascript">
			mui.init({
				swipeBack:true, //Boolean(默认false)启用右滑关闭功能
			})
			var pid;
			var token = plus.storage.getItem('name_token');
			var userid;
			mui.plusReady(function() {
			var self = plus.webview.currentWebview();
			pid = self.pid;
			userid = self.userid;
			console.log('这是传递过来的userid'+userid)
			var text = self.text;
			var username = self.username;
			console.log(pid + text + username);
			var header_title = document.getElementById("header_title");
			var content_text = document.getElementById("content_text");
			header_title.innerHTML = username;
			content_text.innerHTML = text;
			//评论
			gainComment();
			//关注
			Attention();
			//发表评论
			publishComment();
		});
			//发送树洞刷新
			window.addEventListener('refr',function(event){
			  	var id = event.detail.id;
			  	console.log('发送树洞返回的'+id)
			  	gainComment();
			});
			
		//获取评论
		var gainComment = function (){
			var comments = document.getElementById("comment");
			mui.ajax('http://112.74.215.22:5000/api/getComment',{
				data:'article_ID='+pid,
				dataType:'json',//服务器返回json格式数据
				type:'get',//HTTP请求类型
				timeout:10000,//超时时间设置为10秒；
				success:function(data){				
					var data = JSON.stringify(data);
					console.log('评论数据'+data)
					var dataobj = eval("(" + data + ")");
					if(dataobj.success == true){
						if(dataobj.article == null){
							mui.toast("暂无评论!");
						}else{
							var childs = comments.childNodes;
							for(var i = childs.length - 1; i >= 0; i--) { 
							  comments.removeChild(childs[i]); 
							}
							comments.appendChild(createDiv(dataobj));
						}
					}
				},
				error:function(xhr,type,errorThrown){
					mui.toast('获取评论失败！')
					console.log('获取评论失败'+type)
				}
			});
		}
		//创建渲染DIV
		var createDiv = function(dataobj){
			var fragment = document.createDocumentFragment();
			for (var i = 0; i < dataobj.article.length; i++) {
			var avatar = dataobj.article[i].user.avatar;
			var nickname = dataobj.article[i].user.nickname;
			var date = dataobj.article[i].date;
			var text = dataobj.article[i].text;
			var pid = dataobj.article[i]._id;
			div = document.createElement('div');
			div.setAttribute('data-id',pid);
			div.className = 'personal-information';
			div.innerHTML = '<hr />'+
				'<div class="personal-head">'+
					'<div class="head-icon">'+
						'<img src="../imgs/trees/tree'+avatar+'.png" />'+
					'</div>'+
					'<div class="head-title">'+nickname+'</div>'+
					'<div class="head-time">'+date+'</div>'+
				'</div>'+
				'<div class="personal-content">'+text+'</div>';
			fragment.appendChild(div);
			}
			return fragment;
		}
	//发表评论
	var publishComment = function(){
		document.getElementById("publish").addEventListener('tap',function(){
			mui.openWindow({
				url:'reply.html',
				id:'reply.html',
				extras:{
					token:token,
					article_ID:pid
				}
			})
		});
		document.getElementById("comment_text").addEventListener('tap',function(){
			mui.openWindow({
				url:'reply.html',
				id:'reply.html',
				extras:{
					token:token,
					article_ID:pid
				}
			})
		});
	}
	
	//关注
	var Attention = function(){
		document.getElementById("attention_btn").addEventListener('tap',function(){
			console.log(userid)
			console.log(token)
			var w=plus.nativeUI.showWaiting("处理中，请等待...\n", {padlock:true});
			mui.ajax('http://112.74.215.22:5000/api/follow',{
				data:{
					token:token,
					userid:userid
				},
				dataType:'json',//服务器返回json格式数据
				type:'post',//HTTP请求类型
				timeout:10000,//超时时间设置为10秒；
				success:function(data){
					var data = JSON.stringify(data);
					var dataobj = eval("(" + data + ")");
					console.log(data)
					if(dataobj.success==true){
						attention_btn.src = "../imgs/attSuccess.png";
						w.close();
						mui.toast('关注成功！');
					}else{
						w.close();
						console.log('服务器出错，请稍后再试！')
					}
				},
				error:function(xhr,type,errorThrown){
					w.close();
					mui.toast('关注失败，请稍后再试！');
					console.log(type)
				}
			});
		})
	}
	</script>
	</body>

</html>