<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta content="yes" name="apple-mobile-web-app-capable">
		<meta content="yes" name="apple-touch-fullscreen">
		<meta content="telephone=no,email=no" name="format-detection">
		<script type="text/javascript" src="../js/zoom/flexible.js"></script>
		<link rel="stylesheet" href="../css/mui.min.css">
		<style>
			a {
				color: #272727;
				text-decoration: none;
			}
			
			a:link {
				color: #272727;
			}
			
			a:visited {
				color: #272727;
			}
			
			.item-logo {
				width: 100%;
				height: 100%;
				position: relative;
			}
			
			.tree {
				overflow: hidden;
				position: absolute;
				width: 1.597222rem;
				height: 2.361111rem;
			}
			
			.tree img {
				width: 100%;
			}
			
			.tree-0 {
				top: 2.763888rem;
				left: 1.805555rem;
			}
			
			.tree-1 {
				top: 2.277777rem;
				left: 6.083333rem;
			}
			
			.tree-2 {
				top: 2.916666rem;
				left: 9.027777rem;
			}
			
			.tree-3 {
				top: 5.180555rem;
				left: 3.958333rem;
			}
			
			.tree-4 {
				top: 5.25rem;
				left: 7.083333rem;
			}
			
			.tree-5 {
				top: 6.555555rem;
				left: 1.263888rem;
			}
			
			.tree-6 {
				top: 8.722222rem;
				left:4.875rem;
			}
			
			.tree-7 {
				top:7.75rem;
				left:8.736111rem;
			}
			
			.tree-8 {
				top: 10.555555rem;
				left: 1.986111rem;
			}
			
			.tree-9 {
				top: 12.333333rem;
				left: 4.277777rem;
			}
			
			.tree-10 {
				top: 10.430555rem;
				left:7.763888rem;
			}
			
			.tree-11 {
				top: 14.486111rem;
				left: 1.805555rem;
			}
			
			.tree-12 {
				top: 15.166666rem;
				left: 6.027777rem;
			}
			
			.tree-13 {
				top: 14.180555rem;
				left: 8.694444rem;
			}
			
			#popover {
				top: 2.777777rem !important;
				left: 50% !important;
				margin-left: -140px;
				background-color: rgba(247, 247, 247, 0.7);
			}
			
			.mui-popover .mui-popover-arrow {
				display: none;
			}
			
			.popover-box {
				text-align: center;
				position: relative;
			}
			
			.popover-btn {
				position: absolute;
				width: 0.763888rem !important;
				left: 0.138888rem;
				top: 0;
			}
			
			.popover-box img {
				width: 6.083333rem;
				margin-top: 0.138888rem;
			}
			
			.popover-box p {
				color: #272727;
			}
			
			.come-btn {
				position: absolute;
				width: 2.277777rem;
				height: 2.277777rem;
				background-image: url(../imgs/trees/circle.png);
				background-size: 100% 100%;
				z-index: 99999999;
				top: 3.986111rem;
				left: 50%;
				margin-left: -1.133333rem;
				text-align: center;
				font-size: 20px;
				font-weight: 700;
				color: rgba(248, 248, 255, 0.8);
				line-height: 2.277777rem;
			}
		</style>
	</head>

	<body>
		<div id="slider" class="mui-slider mui-fullscreen" style="background-color: #D1E991">
			<div class="mui-slider-group" id="list-box">
				<div class="mui-slider-item">
					<div class="item-logo" style="background-position: left top; background-repeat: no-repeat; background-size: 100% 100%; background-image: url(../imgs/trees/1.png);">
						<a href="javascript:;">
						<div data-index = '{{j}}' data-list='{{treestyle[j]}}' class="tree tree_list tree-{{trees[j]}}"><img src="../imgs/trees/tree1.png" /></div>
						</a>
					</div>
				</div>
			</div>
		</div>
		<div id="popover" class="mui-popover">

		</div>
		<script src="../js/mui.min.js"></script>
		<script src="../js/template.js"></script>
		<script type="text/javascript" src="../js/immersion.js"></script>
		<script type="text/html" id="popover_list">
			<a href="javascript:;">
				<div class="popover-box">
					<img class="popover-btn" src="../imgs/trees/cancel.png" />
					<h2>{{username}}</h2>
					<p>关键字：{{tag}}</p>
					<img src="../imgs/trees/tree{{data_img}}-big.png" />
					<div class="come-btn">
						进入...
					</div>
				</div>
			</a>
		</script>
	<script>
		var randomNumber = randomNumber();//随机数 10个
		var AddrandomNumber = AddrandomNumber(); //随机数（二维数组）
		var listArr = listArr();  //页面数量
		var treeStyle = treeStyle();  //树的样式
		var listIndex = 0; //当前页数
		var listTag = 0; //当页点击位置
		var listbox = document.getElementById('list-box');
		Ajax();
		//图片切换时，触发动画
		document.querySelector('.mui-slider').addEventListener('slide', function(event) {
		 	//注意slideNumber是从0开始的：
		 	listIndex = event.detail.slideNumber;	 	
		});
		//发送树洞刷新
		window.addEventListener('ref',function(event){
		  	var id = event.detail.id;
		  	console.log('发送树洞返回的'+id)
		  	Ajax();
		});

		function Ajax(){
			//获取数据
			mui.ajax('http://112.74.215.22:5000/api/getLast',{
				data:'type=0'+'&count=70',
				dataType:'json',//服务器返回json格式数据
				type:'get',//HTTP请求类型
				timeout:10000,//超时时间设置为10秒；
				success:function(data){
					var data = JSON.stringify(data);
					//添加离线缓存
					plus.storage.setItem("forestdata", data);
					var dataobj = eval("(" + data + ")");
					var datalen = parseInt(dataobj.article.length/10);
					localStorage.setItem('datalen',datalen);
					console.log('这是最新的树洞信息'+data)
					console.log('这是最新的树洞数量'+dataobj.article.length)
					//走新消息渲染				
					 var result = ArtContent();
					 listbox.innerHTML = result;
				},
				error:function(xhr,type,errorThrown){
					console.log('这是首页='+type)
					//走缓存渲染		
					 var result = ArtContent();
					 listbox.innerHTML = result;
				}
			});
		}

			
			// 点开树洞页面
			mui('#list-box').on('tap', '.tree_list', function() {
				var data_img = this.getAttribute("data-list");
				var data_tag = this.getAttribute("data-index");
				listTag = data_tag;
				var index =Number(listIndex+listTag);
				console.log('当前位置'+data_tag);
				var data = JSON.parse(plus.storage.getItem("forestdata"));
				var tag = data.article[index].tag;
				var text = data.article[index].text;
				var username = data.article[index].user.nickname;
				var data = {
					data_img: data_img,
					username: username,
					tag: tag
				}
				var html = template('popover_list', data);
				document.getElementById('popover').innerHTML = html;
				mask.show();
				pop.classList.add('mui-active');
			});
			
			//点击进入按钮
			mui('#popover').on('tap','.come-btn',function(){
				var index =Number(listIndex+listTag);
				console.log("这是传递的位置："+index)
				var data = JSON.parse(plus.storage.getItem("forestdata"));
				var pid = data.article[index]._id;
				var text = data.article[index].text;
				var username = data.article[index].user.nickname;
				var userid = data.article[index].user.id;
				console.log('这是将要传递的userid'+userid)
				mui.openWindow({
					url: 'comment_message.html',
					id: 'comment_message.html',
					extras:{
						pid:pid,
						text:text,
						username:username,
						userid:userid
    				}
				});
			});
			
			//点击遮罩触发事件
			var pop = document.getElementById("popover");
			var mask = mui.createMask(function() {
				pop.classList.remove('mui-active');
			});
			
			//按钮点击事件
			mui('#popover').on('tap','.popover-btn',function(){
				pop.classList.remove('mui-active');
				mask.close();
			});
			
	

		//模板拼接
		function ArtContent(){
			var ULS ='';
			for(var i=0;i<listArr.length;i++){
				var uls = '';
				for(var j=0;j<10;j++){
					uls= uls+'<a href="javascript:;">'+
						'<div data-index = "'+j+'" data-list="'+treeStyle[i][j]+'" class="tree tree_list tree-'+AddrandomNumber[i][j]+'">'+'<img src="../imgs/trees/tree'+treeStyle[i][j]+'.png" /></div>'+
					'</a>'
				}
				ULS = ULS + '<div class="mui-slider-item">'+
					'<div class="item-logo" style="background-position: left top; background-repeat: no-repeat; background-size: 100% 100%; background-image: url(../imgs/trees/'+i+'.png);">'+
					uls+
					'</div>'+
					'</div>'
			}
		return ULS
		}
		
		//二维随机数
		function AddrandomNumber(){
			var len = localStorage.getItem('datalen');
			var Arr = [];
			for(var i=0;i<len;i++){
				Arr[i] = [];
				for(var j=0;j<10;j++){
					Arr[i][j]=randomNumber[j];
				}
			}
			return Arr;
		}
		//页数数组
		function listArr(){
			var allArr = ['1', '2', '3', '4', '5', '6', '7'];
			var list = [];
			var listCount = localStorage.getItem('datalen');
			console.log("这是从缓存中提取到的页数"+listCount)
			for(var i=0;i<listCount;i++){
				list[i]=allArr[i]
			}
			return list;
		}

		//树的样式
		function treeStyle(){
			var treeStyle = new Array();
			var index =0;
			var e = 0;
			var len = localStorage.getItem('datalen');
			var data = JSON.parse(plus.storage.getItem("forestdata"));
			for(var i=0;i<len;i++){
				treeStyle[i] = new Array();
				for(var j=0;j<10;j++){
					e = index++;
					treeStyle[i][j]=data.article[e].user.avatar;
				}
			}	
			return treeStyle;
		}	
	

			//随机数组
			function randomNumber() {
				var source = [
					"0","1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13"
				];
				var sL = source.length;

				var target = []; //存储下标

				//随机4个数组下标
				for(var i = 0; i < 10; i++) {
					var rand = Math.floor(Math.random() * sL);
					if(target.length > 0) {
						detection(target, rand);
					} else {
						target.push(rand);
					}
				}
				//检测num是否存在于arr，存在重新添加，不存在直接添加
				function detection(arr, num) {
					var repeatFlag = false;
					for(var j = 0; j < arr.length; j++) {
						if(arr[j] == num) {
							repeatFlag = true;
						}
					}
					if(repeatFlag) {
						//递归
						arguments.callee(arr, Math.floor(Math.random() * sL));
					} else {
						arr.push(num);
					}
				}
				return target;
			}			
		</script>
	</body>

</html>