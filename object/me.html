<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta content="yes" name="apple-mobile-web-app-capable">
        <meta content="yes" name="apple-touch-fullscreen">
        <meta content="telephone=no,email=no" name="format-detection">
        <script type="text/javascript" src="../js/zoom/flexible.js" ></script>
        <script type="text/javascript" src="../js/zoom/flexible_css.js" ></script>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<style>
		html,body{
			margin: 0;
			padding: 0;
			background-color: #EEEEEE;
		}
			.me-head{
				margin: 0;
				padding: 0;
				width: 10rem;
				height: 9.072222rem;
				background-color: #FBD940;
				box-sizing: border-box;
				padding-top:1.208333rem;
			}
			
			.head-box{
				margin-left:1.791666rem;
				width: 6.416666rem;
				height: 6.416666rem;
				border-radius:200px;
				background-color: #EEEEEE;
			}
			.head-box img{
				width: 4.347222rem;
				height: 5.791666rem;
				margin-top: 0.166666rem;
				margin-left: 1.083333rem;
			}
			.head-title{
				font-size: 0.527777rem;
				color: #272727;
				margin-left: 4.247222rem;
				margin-top: 0.5rem;
				font-weight: bolder;
			}
			.me-message{
				margin-top: 0.402777rem;
				height: 3.166666rem;
				width: 10rem;
				display: flex;
			}
			.message{
				width: 4.95rem;
				height:3.166666rem;
				background: #FBD940;
				position: relative;
				border-right:0.05rem solid #EEEEEE;
			}
			.message img{
				width: 0.805555rem;
				height: 0.611111rem;
				position: absolute;
				top: 1.291666rem;
				left: 0.486111rem;
			}
			.message-title{
				position: absolute;
				top: 1.277777rem;
				left: 1.694444rem;
				font-size: 0.638888rem;
			}
			.attention{
				width: 5.05rem;
				height:3.166666rem;
				background: #FBD940;
				position: relative;
			}
			.attention img{
				width: 0.694444rem;
				height: 0.777777rem;
				position: absolute;
				top:1.111111rem;
				left:0.75rem;
			}
			.me-btn{
				margin-top: 0.402777rem;
			}
			#btn_return{
				border: none;
				background: #FBD940;
				font-size:0.638888rem;
				color: #272727;
				padding: 15px 0;
			}
		</style>
	</head>

	<body>
		<div class="me-head loginBtn" id="head_box">
			<!--<div class="head-box" id="head_icon">
				<img src="../imgs/me/tree0_head.png" />
			</div>
			<div class="head-title" id="comment_message">
				子非鱼
			</div>-->
		</div>
		<div class="me-message">
			<div class="message loginBtn" id="btn_message">
				<img src="../imgs/me/messagge.png" />
				<div class="message-title">我的消息</div>
			</div>
			<div class="attention loginBtn" id="btn_attention">
				<img src="../imgs/me/medal.png" />
				<div class="message-title">我的关注</div>
			</div>
		</div>
		<div class="me-btn">
			<input type="button" id="btn_return" class="mui-btn mui-btn-block loginBtn" value="登录/注册"></input>
		</div>
		<script src="../js/mui.min.js"></script>
		<script src="../js/immersion.js"></script>
		<script type="text/javascript">
		mui.init({
			swipeBack:true, //Boolean(默认false)启用右滑关闭功能
			});
			
		mui.plusReady(function (){
			var btn_return = document.getElementById("btn_return");			
			getData();
			returnBtn();
			btnMess();
			btnAttent();
			//开启回弹
			plus.webview.currentWebview().setStyle({
					bounce: "vertical",
					bounceBackground:"#EEEEEE"
			});
		});
			window.addEventListener('refresh',function(event){
			  var id = event.detail.id;
			  console.log('页面返回的'+id)
			  getData();
			});		
		
		
		var returnBtn = function(){
			btn_return.addEventListener('tap',function(){
				if(btn_return.value == '登录/注册'){
					mui.openWindow('../login/login.html','login');
				}else{
					init();
				}
			});
		}
		
		var init = function(){
			plus.storage.removeItem('name_token');
			getData();
		}
		
		var btnMess = function(){
			var btn_Mess = document.getElementById("btn_message");
			btn_Mess.addEventListener('tap',function(){
				if(btn_return.value == '登录/注册'){
					mui.openWindow('../login/login.html','login');
				}else{
				mui.openWindow({
					url:'myMess.html',
					id:'myMess'
				})
				}
			});
		}
		
		var btnAttent = function(){
			var btn_Attent = document.getElementById("btn_attention");
			btn_Attent.addEventListener('tap',function(){
				if(btn_return.value == '登录/注册'){
					mui.openWindow('../login/login.html','login');
				}else{
				mui.openWindow({
					url:'myAttention.html',
					id:'myAttention'
				})
				}
			});
		}
		//获取数据
		var getData = function(){
			var token = plus.storage.getItem('name_token');
			var head_box = document.getElementById("head_box");
			console.log('这是me页面得token'+token)
			if(token){				
				mui.ajax('http://112.74.215.22:5000/api/getUser',{
					data:'token='+token,
					dataType:'json',//服务器返回json格式数据
					type:'get',//HTTP请求类型
					timeout:10000,//超时时间设置为10秒；
					success:function(data){
						var data = JSON.stringify(data);
						var dataobj = eval("(" + data + ")");
						console.log('这是获取到的me页面数据'+data)
						if(dataobj.success == true){
							var nickname = dataobj.user.nickname;
							var avatar = dataobj.user.avatar;
							head_box.innerHTML = '<div class="head-box" id="head_icon"><img src="../imgs/me/tree'+avatar+'_head.png" /></div><div class="head-title" id="comment_message">'+nickname+'</div>';
							btn_return.value = '退出登录';
						}
					},
					error:function(xhr,type,errorThrown){
						console.log('获取数据失败'+type);
						mui.toast("获取数据失败，请稍后再试！")
					}
				});				
			}else{
				head_box.innerHTML = '<div class="head-box" id="head_icon"><img src="../imgs/me/tree0_head.png" /></div><div class="head-title" id="comment_message"></div>';
				btn_return.value = '登录/注册';
			}
		}
		</script>
	</body>

</html>